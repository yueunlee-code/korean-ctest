<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>한국어 능력 평가 실험</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            margin: 0;
            min-height: 100vh;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            color: #667eea; 
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
        }
        .timer { 
            background: #ff6b6b; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            border-radius: 10px; 
            margin: 20px 0; 
            font-size: 1.2em; 
            font-weight: bold; 
        }
        .passage { 
            border: 2px solid #e0e0e0; 
            border-radius: 10px; 
            padding: 25px; 
            margin: 20px 0; 
            background: #fafafa;
        }
        .passage h3 { 
            color: #667eea; 
            margin-bottom: 15px; 
            font-size: 1.3em;
        }
        .passage-text { 
            line-height: 2; 
            font-size: 1.1em; 
        }
        .blank { 
            display: inline-block; 
            width: 25px; 
            height: 25px; 
            border: none;
            border-bottom: 2px solid #667eea; 
            margin: 0 3px; 
            text-align: center; 
            font-size: 1em; 
            background: #f8f9ff; 
            padding: 2px;
            vertical-align: baseline;
        }
        .blank:focus { 
            outline: none; 
            background: #fff; 
            border-bottom-color: #ff6b6b; 
            box-shadow: 0 2px 5px rgba(102,126,234,0.3);
        }
        .btn { 
            padding: 15px 30px; 
            background: #667eea; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1em; 
            cursor: pointer; 
            margin: 10px; 
        }
        .btn:hover { 
            background: #5a6fd8; 
            transform: translateY(-2px);
        }
        .form-group { 
            margin: 15px 0; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        .form-group input, .form-group select { 
            padding: 10px; 
            width: 100%; 
            max-width: 300px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .results { 
            display: none; 
            text-align: center; 
            padding: 30px; 
            background: #f0f8ff;
            border-radius: 10px;
        }
        .score { 
            font-size: 3em; 
            color: #667eea; 
            font-weight: bold; 
        }
        .participant-info { 
            background: #f0f8ff; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>한국어 C-Test 온라인 평가</h1>
        </div>

        <div id="startForm">
            <h2>참여자 정보</h2>
            <div class="participant-info">
                <div class="form-group">
                    <label>실험자 ID:</label>
                    <input type="text" id="pid" placeholder="예: P001" required>
                </div>
                <div class="form-group">
                    <label>이름:</label>
                    <input type="text" id="pname" placeholder="예: 홍길동" required>
                </div>
                <div class="form-group">
                    <label>나이:</label>
                    <input type="number" id="age" placeholder="예: 25" required>
                </div>
                <div class="form-group">
                    <label>모어:</label>
                    <input type="text" id="lang" placeholder="예: English" required>
                </div>
                <div class="form-group">
                    <label>한국어 학습 기간:</label>
                    <select id="duration" required>
                        <option value="">선택하세요</option>
                        <option value="6개월 미만">6개월 미만</option>
                        <option value="6개월-1년">6개월-1년</option>
                        <option value="1-2년">1-2년</option>
                        <option value="2-3년">2-3년</option>
                        <option value="3년 이상">3년 이상</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>이메일:</label>
                    <input type="email" id="email" placeholder="example@email.com" required>
                </div>
                <div class="form-group">
                    <label>핸드폰:</label>
                    <input type="tel" id="phone" placeholder="010-1234-5678" required>
                </div>
            </div>
            <button class="btn" onclick="startTest()">시험 시작 (20분)</button>
        </div>

        <div id="testArea" style="display:none;">
            <div class="timer" id="timer">남은 시간: 20:00</div>

            <div class="passage">
                <h3>지문 1: 일상생활</h3>
                <div class="passage-text">
                    안녕하세요. 제 이름은 김철수입니다. 저는 대학<input class="blank" data-answer="교" maxlength="1"><input class="blank" data-answer="에" maxlength="1"> 다닙니다.<br><br>
                    아침에 일어<input class="blank" data-answer="나" maxlength="1"><input class="blank" data-answer="서" maxlength="1"> 학교에 갑니다. 한국어를 배<input class="blank" data-answer="우" maxlength="1"><input class="blank" data-answer="는" maxlength="1"> 것이 재미<input class="blank" data-answer="있" maxlength="1"><input class="blank" data-answer="습" maxlength="1"><input class="blank" data-answer="니" maxlength="1"><input class="blank" data-answer="다" maxlength="1">.<br><br>
                    한국어 수<input class="blank" data-answer="업" maxlength="1"><input class="blank" data-answer="은" maxlength="1"> 매일 있습니다. 쓰<input class="blank" data-answer="기" maxlength="1"><input class="blank" data-answer="와" maxlength="1"> 말하기가 어<input class="blank" data-answer="렵" maxlength="1"><input class="blank" data-answer="습" maxlength="1"><input class="blank" data-answer="니" maxlength="1"><input class="blank" data-answer="다" maxlength="1">. 그렇지만 듣<input class="blank" data-answer="기" maxlength="1"><input class="blank" data-answer="와" maxlength="1"> 읽기는 쉽<input class="blank" data-answer="습" maxlength="1"><input class="blank" data-answer="니" maxlength="1"><input class="blank" data-answer="다" maxlength="1">.<br><br>
                    주말에는 친<input class="blank" data-answer="구" maxlength="1"><input class="blank" data-answer="와" maxlength="1"> 영화를 봅니다. 한국 음<input class="blank" data-answer="식" maxlength="1"><input class="blank" data-answer="을" maxlength="1"> 먹고 쇼<input class="blank" data-answer="핑" maxlength="1"><input class="blank" data-answer="을" maxlength="1"> 합니다.
                </div>
            </div>

            <div class="passage">
                <h3>지문 2: 여행 계획</h3>
                <div class="passage-text">
                    제주도는 한국의 남쪽에 있<input class="blank" data-answer="는" maxlength="1"> 섬입니다. 자연이 아름다<input class="blank" data-answer="워" maxlength="1"><input class="blank" data-answer="서" maxlength="1"> 유명합니다.<br><br>
                    여행<input class="blank" data-answer="사" maxlength="1"><input class="blank" data-answer="에" maxlength="1"> 전화를 걸<input class="blank" data-answer="어" maxlength="1"> 비행<input class="blank" data-answer="기" maxlength="1"> 표를 예<input class="blank" data-answer="약" maxlength="1">했습니다. 호텔도 정<input class="blank" data-answer="했" maxlength="1"><input class="blank" data-answer="어" maxlength="1"><input class="blank" data-answer="요" maxlength="1">.<br><br>
                    인터넷<input class="blank" data-answer="이" maxlength="1"> 있어서 편<input class="blank" data-answer="리" maxlength="1">합니다. 맛<input class="blank" data-answer="있" maxlength="1"><input class="blank" data-answer="는" maxlength="1"> 식당도 찾<input class="blank" data-answer="을" maxlength="1"> 수 있<input class="blank" data-answer="어" maxlength="1"><input class="blank" data-answer="서" maxlength="1"> 좋습니다.<br><br>
                    가족들<input class="blank" data-answer="과" maxlength="1"> 함께 가<input class="blank" data-answer="는" maxlength="1"> 여행이 기<input class="blank" data-answer="대" maxlength="1">됩니다.
                </div>
            </div>

            <div class="passage">
                <h3>지문 3: 백화점 쇼핑</h3>
                <div class="passage-text">
                    백화점에서 겨울<input class="blank" data-answer="옷" maxlength="1"><input class="blank" data-answer="을" maxlength="1"> 사려고 합니다. 여성<input class="blank" data-answer="복" maxlength="1"> 코너에서 정<input class="blank" data-answer="장" maxlength="1"><input class="blank" data-answer="을" maxlength="1"> 샀습니다.<br><br>
                    아동복 코너에서는 코<input class="blank" data-answer="트" maxlength="1">, 장<input class="blank" data-answer="갑" maxlength="1"> 등을 팔고 있<input class="blank" data-answer="습" maxlength="1"><input class="blank" data-answer="니" maxlength="1"><input class="blank" data-answer="다" maxlength="1">. 할<input class="blank" data-answer="인" maxlength="1"> 가격에 살 수 있<input class="blank" data-answer="어" maxlength="1"><input class="blank" data-answer="서" maxlength="1"> 좋습니다.<br><br>
                    전자제<input class="blank" data-answer="품" maxlength="1"> 코너에서는 컴퓨<input class="blank" data-answer="터" maxlength="1"><input class="blank" data-answer="와" maxlength="1"> 휴대<input class="blank" data-answer="폰" maxlength="1"><input class="blank" data-answer="을" maxlength="1"> 팝니다. 세<input class="blank" data-answer="일" maxlength="1"> 기간에 많<input class="blank" data-answer="이" maxlength="1"> 샀습니다.
                </div>
            </div>

            <div class="passage">
                <h3>지문 4: 교통 문제</h3>
                <div class="passage-text">
                    도시의 교통 문제가 심각합니다. 교<input class="blank" data-answer="통" maxlength="1"> 체증으로 시<input class="blank" data-answer="간" maxlength="1"><input class="blank" data-answer="이" maxlength="1"> 많이 걸립니다.<br><br>
                    출<input class="blank" data-answer="퇴" maxlength="1"><input class="blank" data-answer="근" maxlength="1"> 시간에는 도<input class="blank" data-answer="로" maxlength="1"><input class="blank" data-answer="가" maxlength="1"> 복<input class="blank" data-answer="잡" maxlength="1">합니다. 주<input class="blank" data-answer="차" maxlength="1"> 공간이 부족<input class="blank" data-answer="해" maxlength="1"><input class="blank" data-answer="서" maxlength="1"> 문제입니다.<br><br>
                    버스나 지하<input class="blank" data-answer="철" maxlength="1"><input class="blank" data-answer="을" maxlength="1"> 이용하는 것이 좋습니다. 환경<input class="blank" data-answer="에" maxlength="1"><input class="blank" data-answer="도" maxlength="1"> 도움이 됩<input class="blank" data-answer="니" maxlength="1"><input class="blank" data-answer="다" maxlength="1">.<br><br>
                    정부에서는 대중교<input class="blank" data-answer="통" maxlength="1"> 시설을 더 많<input class="blank" data-answer="이" maxlength="1"> 만들고 있습니다.
                </div>
            </div>

            <button class="btn" onclick="finishTest()">시험 완료</button>
        </div>

        <div id="resultArea" class="results">
            <div class="score" id="score">0%</div>
            <p>총 <span id="total">0</span>문항 중 <span id="correct">0</span>문항 정답</p>
            <p>사용 시간: <span id="timeUsed">0</span>분</p>
            <br>
            <button class="btn" onclick="downloadCSV()">결과 다운로드 (CSV)</button>
            <button class="btn" onclick="location.reload()">다시 시작</button>
        </div>
    </div>

    <script>
        let timer = 20 * 60; // 20분으로 변경
        let interval;
        let startTime;
        let userData = {};

        function startTest() {
            // 폼 검증
            const pid = document.getElementById('pid').value.trim();
            const pname = document.getElementById('pname').value.trim();
            const age = document.getElementById('age').value.trim();
            const lang = document.getElementById('lang').value.trim();
            const duration = document.getElementById('duration').value;
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if (!pid || !pname || !age || !lang || !duration || !email || !phone) {
                alert('모든 정보를 입력해주세요.');
                return;
            }

            userData = { pid, pname, age, lang, duration, email, phone };
            startTime = new Date();

            // 화면 전환
            document.getElementById('startForm').style.display = 'none';
            document.getElementById('testArea').style.display = 'block';

            // 빈칸 입력 이벤트 설정
            setupBlankInputs();

            // 타이머 시작
            interval = setInterval(function() {
                timer--;
                let min = Math.floor(timer / 60);
                let sec = timer % 60;
                document.getElementById('timer').textContent = `남은 시간: ${min}:${sec < 10 ? '0' : ''}${sec}`;
                
                if (timer <= 0) {
                    clearInterval(interval);
                    alert('시간 종료! 자동 제출됩니다.');
                    finishTest();
                }
            }, 1000);
        }

        function setupBlankInputs() {
            const blanks = document.querySelectorAll('.blank');
            blanks.forEach(function(blank, index) {
                // 각 입력칸에 고유 ID 부여
                blank.id = 'blank_' + index;
                
                // 입력 완료 후 처리
                blank.addEventListener('input', function() {
                    // 잠시 후 처리하여 IME 완료를 기다림
                    setTimeout(() => {
                        let value = this.value;
                        
                        // 완성된 한글만 추출 (가-힣)
                        let koreanChars = value.match(/[가-힣]/g);
                        
                        if (koreanChars && koreanChars.length > 0) {
                            // 첫 번째 완성된 한글만 사용
                            this.value = koreanChars[0];
                            
                            // 다음 빈칸으로 이동
                            moveToNext(this);
                        } else {
                            // 완성된 한글이 없으면 비움
                            this.value = '';
                        }
                    }, 100);
                });
                
                // 키 입력 처리
                blank.addEventListener('keydown', function(e) {
                    // 백스페이스, 탭, 엔터는 허용
                    if (e.key === 'Backspace' || e.key === 'Tab' || e.key === 'Enter') {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            moveToNext(this);
                        }
                        return;
                    }
                    
                    // 이미 글자가 있으면 지우고 새로 입력
                    if (this.value.length > 0) {
                        this.value = '';
                    }
                });
                
                // 포커스 시 전체 선택
                blank.addEventListener('focus', function() {
                    this.select();
                });
                
                // 붙여넣기 방지
                blank.addEventListener('paste', function(e) {
                    e.preventDefault();
                });
            });
        }
        
        // 다음 빈칸으로 이동하는 함수
        function moveToNext(currentBlank) {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            const currentIndex = blanks.indexOf(currentBlank);
            if (currentIndex < blanks.length - 1) {
                setTimeout(() => {
                    blanks[currentIndex + 1].focus();
                }, 100);
            }
        }

        function finishTest() {
            if (!confirm('시험을 제출하시겠습니까?')) return;
            
            clearInterval(interval);
            
            const blanks = document.querySelectorAll('.blank');
            let totalCount = 0;
            let correctCount = 0;
            let results = [];
            
            blanks.forEach(function(blank, index) {
                if (blank.dataset.answer) {
                    totalCount++;
                    const isCorrect = blank.value === blank.dataset.answer;
                    if (isCorrect) correctCount++;
                    
                    results.push({
                        item: index + 1,
                        userAnswer: blank.value,
                        correctAnswer: blank.dataset.answer,
                        correct: isCorrect
                    });
                }
            });

            const percentage = Math.round((correctCount / totalCount) * 100);
            const timeUsed = 20 - Math.floor(timer / 60); // 20분에서 남은시간 빼기
            
            // 결과 저장
            window.testResult = {
                userData: userData,
                startTime: startTime,
                endTime: new Date(),
                timeUsed: timeUsed,
                totalCount: totalCount,
                correctCount: correctCount,
                percentage: percentage,
                details: results
            };

            // 로컬 저장
            localStorage.setItem(`result_${userData.pid}_${Date.now()}`, JSON.stringify(window.testResult));

            // 결과 화면 표시
            document.getElementById('testArea').style.display = 'none';
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('score').textContent = percentage + '%';
            document.getElementById('total').textContent = totalCount;
            document.getElementById('correct').textContent = correctCount;
            document.getElementById('timeUsed').textContent = timeUsed;
        }

        function downloadCSV() {
            if (!window.testResult) return;
            
            let csv = 'ParticipantID,Name,Age,MotherTongue,StudyDuration,Email,Phone,TestDate,TotalScore,CorrectCount,TotalItems,Percentage,TimeUsed\n';
            const r = window.testResult;
            csv += `${r.userData.pid},${r.userData.pname},${r.userData.age},${r.userData.lang},${r.userData.duration},${r.userData.email},${r.userData.phone},${r.startTime.toISOString()},${r.correctCount}/${r.totalCount},${r.correctCount},${r.totalCount},${r.percentage}%,${r.timeUsed}분\n\n`;
            
            // 상세 결과 추가
            csv += 'ItemNumber,UserAnswer,CorrectAnswer,IsCorrect\n';
            r.details.forEach(function(item) {
                csv += `${item.item},${item.userAnswer},${item.correctAnswer},${item.correct}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Korean_CTest_${r.userData.pid}_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // 연구자용 - 모든 결과 내보내기
        function exportAllResults() {
            const allResults = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('result_')) {
                    try {
                        allResults.push(JSON.parse(localStorage.getItem(key)));
                    } catch (e) {
                        console.log('파싱 오류:', key);
                    }
                }
            }
            
            if (allResults.length === 0) {
                alert('저장된 결과가 없습니다.');
                return;
            }

            let csv = 'ParticipantID,Name,Age,MotherTongue,StudyDuration,Email,Phone,TestDate,TotalScore,CorrectCount,TotalItems,Percentage,TimeUsed\n';
            allResults.forEach(function(r) {
                csv += `${r.userData.pid},${r.userData.pname},${r.userData.age},${r.userData.lang},${r.userData.duration},${r.userData.email},${r.userData.phone},${r.startTime},${r.correctCount}/${r.totalCount},${r.correctCount},${r.totalCount},${r.percentage}%,${r.timeUsed}분\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Korean_CTest_AllResults_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        console.log('한국어 C-Test가 로드되었습니다.');
        console.log('연구자용: 모든 결과를 다운로드하려면 exportAllResults() 실행');
    </script>
</body>
</html>
